{"componentChunkName":"component---src-templates-best-practice-detail-tsx","path":"/best-practice/2021-08-11-api","result":{"data":{"currentBlog":{"id":"effc29bc-c29f-584c-b342-625e1cb372c6","frontmatter":{"thumbnail":"https://main.qcloudimg.com/raw/e92240ba73236d632fcaa13eb24182f3.jpg","authors":["吴宜展、毛勤斌"],"categories":["best-practice"],"date":"2021-08-11T00:00:00.000Z","title":"使用腾讯云 API 网关实现多维度精细化限流","description":"使用腾讯云 API 网关实现多维度，精细化的限流，最大程度上保护您的业务安全。","authorslink":null,"translators":null,"translatorslink":null,"tags":["Serverless","云函数"],"keywords":null,"outdated":null},"wordCount":{"words":288,"sentences":50,"paragraphs":50},"fileAbsolutePath":"/Users/zhangxuewen/serverlesscloud.cn/content/best-practice/2021-08-11-api.md","fields":{"slug":"/best-practice/2021-08-11-api/","keywords":["serverless","限流","网关","插件","流量"]},"html":"<p>一个系统的处理能力是有上限的，当遇到抢购等高并发场景时，如果不采取任何措施，大量的请求会使得系统在短时间内崩溃，造成不可预计的后果。这时就需要使用<strong>「限流」</strong>来对系统进行保护。</p>\n<p>「限流」是指限制并发访问数或者限制一个时间窗口内允许处理的请求数量来保护系统，一旦达到限制数量，则对当前请求进行处理采取对应的拒绝措施，比如跳转到错误页面、拒绝请求等。<strong>从本质上来说，「限流」的主要作用是损失一部分用户的可用性，为大部分用户提供稳定可靠的服务。</strong>「限流」是 API 网关最核心的能力之一，本文将带您了解如何使用腾讯云 API 网关实现多维度，精细化的限流，最大程度上保护您的业务安全。</p>\n<h2 id=\"01-使用-api-网关实现限流\" style=\"position:relative;\"><a href=\"#01-%E4%BD%BF%E7%94%A8-api-%E7%BD%91%E5%85%B3%E5%AE%9E%E7%8E%B0%E9%99%90%E6%B5%81\" aria-label=\"01 使用 api 网关实现限流 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>01. 使用 API 网关实现限流</h2>\n<img src=\"https://main.qcloudimg.com/raw/11bb71b36b4b185122063948756c489e.png\" width=\"700\">\n<p>如图，在腾讯云 API 网关上主要可以通过 3 个方面进行流量管理，保护后端安全：</p>\n<ol>\n<li>使用流量控制插件实现多维度精细化限流；</li>\n<li>支持在 API 网关上调整主次业务限流值，为核心业务分配更多资源；</li>\n<li>API 网关提供完善的实时日志、监控、告警能力，方便即时调整限流策略。</li>\n</ol>\n<p><strong>方案优势</strong></p>\n<ul>\n<li><strong>免改造</strong></li>\n</ul>\n<p>限流策略都收敛在网关层，无需改造后台服务即可接入；</p>\n<ul>\n<li><strong>维度多</strong></li>\n</ul>\n<p>支持多种维度的限流，大到整个服务，小到某个用户都可以设置限流。同时支持各种维度间的自由组合，满足的业务场景多；</p>\n<ul>\n<li><strong>性能好</strong></li>\n</ul>\n<p>基于开源的经典限流算法优化，同等条件下性能优于传统的解决方案（如 Nginx 限流），限流功能本身几乎不影响接口性能；</p>\n<ul>\n<li><strong>支持流量分析</strong></li>\n</ul>\n<p>提供丰富的流量看板和支持实时查询流量数据的云 API，可基于流量数据分析，优化限流策略。</p>\n<h2 id=\"02api-网关流量控制插件\" style=\"position:relative;\"><a href=\"#02api-%E7%BD%91%E5%85%B3%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E6%8F%92%E4%BB%B6\" aria-label=\"02api 网关流量控制插件 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>02.「API 网关」流量控制插件</h2>\n<p>使用流量控制插件是 API 网关提供的进行流控限制的主要方式，支持设置三种资源维度（API、应用、ClientIP）和四种时间维度（秒、分钟、小时、天）的限流。插件中还支持设置特殊的应用和特殊 ClientIP，特例的限流值将覆盖默认的应用、ClientIP 的限流值。</p>\n<p>您可创建基础流控插件并绑定到 API 生效，以保护您的后端服务。流控插件的使用步骤如下：</p>\n<ol>\n<li>登录 API 网关控制台。</li>\n<li>控制台地址：<a href=\"https://console.cloud.tencent.com/api\">https://console.cloud.tencent.com/api</a></li>\n<li>在左侧导航栏，单击「插件」，进入插件列表页，单击页面左上角的「新建」，选择插件类型为<strong>「基础流量控制」</strong>，新建一个基础流量控制插件，按照您的实际业务需求配置后，点击「保存」按钮。</li>\n</ol>\n<img src=\"https://main.qcloudimg.com/raw/acc68c89f24fdbf6a9eb4bf290f24f66.png\" width=\"700\">\n<ol start=\"3\">\n<li>在插件列表中选中刚刚创建好的插件，点击操作列的「绑定API」，在绑定 API 弹窗中选择服务和环境，并选择需要绑定插件的 API。</li>\n</ol>\n<img src=\"https://main.qcloudimg.com/raw/fc05e39e3082d526cabd48eb7c9c3cc3.png\" width=\"700\">\n<ol start=\"4\">\n<li>单击「确定」，即可将插件绑定到 API，此时插件的配置已经对 API 生效。</li>\n</ol>\n<h2 id=\"03api-网关服务降级\" style=\"position:relative;\"><a href=\"#03api-%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7\" aria-label=\"03api 网关服务降级 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>03.「API 网关」服务降级</h2>\n<p>服务降级是限流的常用手段，其主要思路是在后端压力剧增的情况下，根据当前业务情况及流量对一些服务和页面有策略的降级，以此释放服务器资源以保证核心任务的正常运行。通过 API 网关的实例、服务、API 限流功能可以便捷的实现服务降级。</p>\n<p><strong>1. 通过 API 网关服务区分不同业务模块</strong></p>\n<img src=\"https://main.qcloudimg.com/raw/adb1baa6a82482bbfa1fb2558b6595a9.png\" width=\"700\">\n<p>专享实例可提供更高的性能，当您通过API网关服务来区分不同业务模块时，可从逻辑上区分主次业务，将次要业务落在共享实例，将核心业务落在专享实例中，以便为核心业务提供更多资源。两种实例间支持无感知的迁移切换，当业务逻辑变化时，也能方便的进行调整。</p>\n<p><strong>2. 通过 API 网关 API 区分不同业务模块</strong></p>\n<img src=\"https://main.qcloudimg.com/raw/e98e61c4fc055bb92b0f7e765865a06d.png\" width=\"700\">\n<p>当您通过 API 网关来区分不同业务模块时，业务相关的一组 API 都处于同一个服务下，该服务的 QPS 上限是固定的；因此，您可前往 API 详情页，为核心 API 设置高 QPS 上限，为此要 API 设置低 QPS 上限，采用「弃车保帅」的策略，保证核心业务的访问。</p>\n<h2 id=\"04api-网关实时流量监控\" style=\"position:relative;\"><a href=\"#04api-%E7%BD%91%E5%85%B3%E5%AE%9E%E6%97%B6%E6%B5%81%E9%87%8F%E7%9B%91%E6%8E%A7\" aria-label=\"04api 网关实时流量监控 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>04.「API 网关」实时流量监控</h2>\n<p>API 网关基于云日志服务 CLS 和云监控提供完善的实时日志、监控、告警能力，目前支持的监控指标包括请求数、出流量、响应时间、错误数等，所有监控指标都支持 1 分钟、5 分钟、1 小时、1 天四种时间维度，也开放了标准的云 API 供用户调用查询。</p>\n<p>您可以在抢购等高并发活动期间，通过控制台监控面板或云 API 实时监控业务流量的变化，根据实际情况不断自动或手动调整限流策略，以达到最好的限流效果。</p>\n<img src=\"https://main.qcloudimg.com/raw/65a88eaf7aa6bf9de36c119ca9a818e5.png\" width=\"700\">\n<h2 id=\"05api-网关限流技术优势\" style=\"position:relative;\"><a href=\"#05api-%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81%E6%8A%80%E6%9C%AF%E4%BC%98%E5%8A%BF\" aria-label=\"05api 网关限流技术优势 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>05.「API 网关」限流技术优势</h2>\n<p>腾讯云 API 网关限流是基于经典令牌桶算法进行优化，性能较通用方案有了有效提升，依赖腾讯云上高可用高性能的中控平台，具备以下优势：</p>\n<ul>\n<li>能够有效控制 API 平均请求频率；</li>\n<li>平滑处理系统负载，有力应对流量突增；</li>\n<li>动态计算令牌速率，减少性能损耗；</li>\n<li>多维度集群化的高精度流控，全力保证后端服务安全。</li>\n</ul>\n<img src=\"https://main.qcloudimg.com/raw/4dad284376842601724ad38745424e8f.png\" width=\"700\">\n<h4 id=\"\" style=\"position:relative;\"><a href=\"#\" aria-label=\" permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<h4 id=\"未来展望\" style=\"position:relative;\"><a href=\"#%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B\" aria-label=\"未来展望 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>未来展望</h4>\n<p>目前腾讯云 API 网关已经支持了非常强大的限流能力，我们也在此基础上不断深耕探索，未来的重点一方面是不断优化限流算法，提供极致的性能；另一方面 API 网关将推出基于请求参数的限流能力，满足更多限流场景，敬请期待！</p>\n<h2 id=\"06-直播预告参与有礼-\" style=\"position:relative;\"><a href=\"#06-%E7%9B%B4%E6%92%AD%E9%A2%84%E5%91%8A%E5%8F%82%E4%B8%8E%E6%9C%89%E7%A4%BC-\" aria-label=\"06 直播预告参与有礼  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>06. 直播预告，参与有礼 🎁</h2>\n<p>参与直播互动，将有机会 <strong>免费获得</strong> 腾讯视频 VIP 月卡 1 张！</p>\n<p><a href=\"https://cloud.tencent.com/developer/salon/live-1515\">点击预约直播</a> <strong>8 月 16 日，晚 7 点见！</strong></p>\n<img src=\"https://main.qcloudimg.com/raw/96fcfe58d83bd7d7688354bc432955a6.png\" width=\"500\">\n<hr>\n<blockquote>\n<p><strong>传送门：</strong></p>\n<ul>\n<li>GitHub: <a href=\"https://github.com/serverless/serverless/blob/master/README_CN.md\">github.com/serverless</a></li>\n<li>官网：<a href=\"https://serverless.com/\">serverless.com</a></li>\n</ul>\n</blockquote>\n<p>欢迎访问：<a href=\"https://serverlesscloud.cn/\">Serverless 中文网</a>，您可以在 <a href=\"https://serverlesscloud.cn/best-practice\">最佳实践</a> 里体验更多关于 Serverless 应用的开发！</p>","tableOfContents":"<ul>\n<li><a href=\"/best-practice/2021-08-11-api/#01-%E4%BD%BF%E7%94%A8-api-%E7%BD%91%E5%85%B3%E5%AE%9E%E7%8E%B0%E9%99%90%E6%B5%81\">01. 使用 API 网关实现限流</a></li>\n<li><a href=\"/best-practice/2021-08-11-api/#02api-%E7%BD%91%E5%85%B3%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E6%8F%92%E4%BB%B6\">02.「API 网关」流量控制插件</a></li>\n<li><a href=\"/best-practice/2021-08-11-api/#03api-%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7\">03.「API 网关」服务降级</a></li>\n<li><a href=\"/best-practice/2021-08-11-api/#04api-%E7%BD%91%E5%85%B3%E5%AE%9E%E6%97%B6%E6%B5%81%E9%87%8F%E7%9B%91%E6%8E%A7\">04.「API 网关」实时流量监控</a></li>\n<li>\n<p><a href=\"/best-practice/2021-08-11-api/#05api-%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81%E6%8A%80%E6%9C%AF%E4%BC%98%E5%8A%BF\">05.「API 网关」限流技术优势</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"/best-practice/2021-08-11-api/#%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B\">未来展望</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"/best-practice/2021-08-11-api/#06-%E7%9B%B4%E6%92%AD%E9%A2%84%E5%91%8A%E5%8F%82%E4%B8%8E%E6%9C%89%E7%A4%BC-\">06. 直播预告，参与有礼 🎁</a></li>\n</ul>"},"previousBlog":{"id":"0bf282d4-a8cd-5d85-a4a5-800674217ae6","frontmatter":{"thumbnail":"https://main.qcloudimg.com/raw/df4800b88b1c76a8a4b288a7ec037b8d.jpg","authors":["希蒂恩、kbjlchen"],"categories":["best-practice"],"date":"2021-08-11T00:00:00.000Z","title":"CDN 联合云函数 SCF，轻松实现定时刷新、预热任务","description":"插件中心是腾讯云 CDN 的增值插件功能的大本营，全新上线：定时刷新预热、APK 动态打包、区域访问控制！","authorslink":null,"translators":null,"translatorslink":null,"tags":["Serverless","云函数"],"keywords":null,"outdated":null},"wordCount":{"words":173,"sentences":32,"paragraphs":32},"fileAbsolutePath":"/Users/zhangxuewen/serverlesscloud.cn/content/best-practice/2021-08-09-cdn-scf.md","fields":{"slug":"/best-practice/2021-08-09-cdn-scf/","keywords":["serverless","云函数","预热","刷新","插件","定时"]}},"nextBlog":{"id":"e8f1de5c-5df1-5469-98d3-99cba460ee7a","frontmatter":{"thumbnail":"https://main.qcloudimg.com/raw/218959106c61e9f79cf9665f944ef82d.jpg","authors":["腾讯云存储"],"categories":["best-practice"],"date":"2021-08-10T00:00:00.000Z","title":"COS 数据工作流 + 云函数最佳实践 - 自定义音视频转码","description":"快速创建满足需求的各种音视频处理服务的工作流。","authorslink":null,"translators":null,"translatorslink":null,"tags":["Serverless","云函数"],"keywords":null,"outdated":null},"wordCount":{"words":170,"sentences":44,"paragraphs":43},"fileAbsolutePath":"/Users/zhangxuewen/serverlesscloud.cn/content/best-practice/2021-08-10-cos-scf.md","fields":{"slug":"/best-practice/2021-08-10-cos-scf/","keywords":["serverless","云函数","函数","width"]}}},"pageContext":{"blogId":"effc29bc-c29f-584c-b342-625e1cb372c6","previousBlogId":"0bf282d4-a8cd-5d85-a4a5-800674217ae6","nextBlogId":"e8f1de5c-5df1-5469-98d3-99cba460ee7a"}},"staticQueryHashes":["126728070","2100134136"]}